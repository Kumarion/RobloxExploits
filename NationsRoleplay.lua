--// Services
local Players = game:GetService("Players");
local RunService = game:GetService("RunService");

--// Variables/Constants
local Map = workspace.Map;
local LocalPlayer = Players.LocalPlayer;
local Parts = {};
local Connections = {};
local Lower = string.lower;
local Upper = string.upper;
local Sub = string.sub;
local Len = string.len;
local MathRandom = math.random;
local AmountOfConnectionsToMake = 15;

--// Collect list of "Plots of Land" in this game
warn("[CountryDestroyer: Initializing CountryDestroyer");

--// Commands
local destroyCommand = "/takeover";
local stopDestroyCommand = "/stoptakeover";

--// Helpers
local function ToHEX(color)
	return string.format("#%02X%02X%02X", color.R * 0xFF,
			color.G * 0xFF, color.B * 0xFF)
end

local function FromHEX(hex)
	local r, g, b = string.match(hex, "^#?(%w%w)(%w%w)(%w%w)$");
	return Color3.fromRGB(tonumber(r, 16), tonumber(g, 16), tonumber(b, 16));
end

--// Load parts into a table
--// Get all the parts in workspace just for fun
for _, Part in pairs(workspace:GetDescendants()) do
	if Part:IsA("BasePart") then
		table.insert(Parts, Part);
	end;
end;

--// Get all the parts in the actual nations/provinces
for _, Part in pairs(Map:GetChildren()) do
	if (Part.Name == "Part") then
		table.insert(Parts, Part);
	end;
end;

local function SendData(Data)
	local YourWorkspaceCharacter = workspace:FindFirstChild(LocalPlayer.Name);

	if (YourWorkspaceCharacter ~= nil) then
		YourWorkspaceCharacter.PaintBucket.Remotes.ServerControls:InvokeServer("PaintPart", Data);
	end;
end

local function Setup(Arguments)
	local Hex = Arguments[2];
	local Hex2 = Arguments[3];
	local Color3Value = nil;

	if (#Arguments == 0) then
		warn("No arguments specified");
		return;
	end;

	if (Hex ~= nil and Hex2 == nil) then
		Color3Value = FromHEX(Hex);
	elseif (Hex ~= nil and Hex2 ~= nil) then
		Color3Value = {FromHEX(Hex), FromHEX(Hex2)};
	end;

	for _ = 1, AmountOfConnectionsToMake do
		--// Make like 15 heartbeat connections, shouldnt crash
		Connections[#Connections + 1] = RunService.Heartbeat:Connect(function()
			local ThePart = Parts[MathRandom(1, #Parts)];
			local RandomColor = nil;

			if (typeof(Color3Value) == "table") then
				RandomColor = Color3Value[MathRandom(1, #Color3Value)];
			elseif (typeof(Color3Value) == "Color3") then
				RandomColor = Color3Value;
			end;

			if (ToHEX(ThePart.Color) ~= ToHEX(RandomColor)) then
				local TableToSend = {
					Part = ThePart,
					Color = RandomColor,
				};

				--// Keep spamming the remote
				SendData(TableToSend);
			end;
		end);
	end
end

local function Destroy()
	--// Stops all the connections
	for Index, Value in pairs(Connections) do
		if (typeof(Value) == "RBXScriptConnection") then
			Connections[Index]:Disconnect();
			Connections[Index] = nil;
		end;
	end;
end

--// Events
local function onPlayerChatted(player, message, recipient)
	local Arguments = {};

	for Argument in string.gmatch(message, "[^%s]+") do
		table.insert(Arguments, Argument);
	end;

	if Lower(Sub(message, 1, Len(destroyCommand))) == Lower(destroyCommand) then
		Setup(Arguments);
	elseif Lower(Sub(message, 1, Len(stopDestroyCommand))) == Lower(stopDestroyCommand) then
		Destroy();
	end;
end

LocalPlayer.Chatted:Connect(function(message, recipient)
	onPlayerChatted(LocalPlayer, message, recipient);
end)

warn("[CountryDestroyer: Finished loading CountryDestroyer");